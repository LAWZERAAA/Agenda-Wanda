<script>
// =========================
// CONFIGURA√á√ÉO
// =========================

const telefoneWhatsApp = "5519992880591";

// Hor√°rios poss√≠veis
const horariosBase = ["08:00","09:00","10:00","11:00","13:00","14:00","15:00","16:00","17:00"];

// Servi√ßos: pre√ßo e dura√ß√£o (todos = 1h)
const servicos = [
  { id: "estetica_pes", nome: "Est√©tica dos P√©s", precoTexto: "R$ 40,00", duracao: 60 },
  { id: "estetica_maos", nome: "Est√©tica das M√£os", precoTexto: "R$ 35,00", duracao: 60 },
  { id: "podologia_completa", nome: "Podologia Completa", precoTexto: "a partir de R$ 100,00", duracao: 60 },
  { id: "plastica_pes", nome: "Pl√°stica dos P√©s", precoTexto: "R$ 80,00", duracao: 60 }
];

let adminLogado = false;


// =========================
// FUN√á√ïES DE HORA
// =========================

function hhmmParaMinutos(hhmm){
  const [h,m] = hhmm.split(":").map(Number);
  return h*60 + m;
}

function intervalosSobrepoem(aInicio, aDur, bInicio, bDur){
  const aFim = aInicio + aDur;
  const bFim = bInicio + bDur;
  return (aInicio < bFim) && (bInicio < aFim);
}


// =========================
// POPULAR SERVI√áOS
// =========================

function popularServicos(){
  const sel = document.getElementById("servico");
  if(!sel) return;

  sel.innerHTML = `<option value="" disabled selected>Selecione o servi√ßo</option>`;

  servicos.forEach(s => {
    const op = document.createElement("option");
    op.value = s.id;
    op.textContent = `${s.nome} ‚Äî ${s.precoTexto} (1h)`;
    sel.appendChild(op);
  });

  sel.onchange = atualizarHorarios;
}


// =========================
// MOSTRAR HOR√ÅRIOS DISPON√çVEIS
// =========================

function atualizarHorarios(){
  const data = document.getElementById("data")?.value;
  const servicoID = document.getElementById("servico")?.value;
  const horaSel = document.getElementById("hora");

  if(!horaSel) return;
  horaSel.innerHTML = "";

  if(!data || !servicoID){
    const op = document.createElement("option");
    op.textContent = "Selecione data e servi√ßo";
    op.disabled = true;
    op.selected = true;
    horaSel.appendChild(op);
    return;
  }

  const servico = servicos.find(s => s.id === servicoID);

  const agenda = JSON.parse(localStorage.getItem("agenda")) || [];
  const ocupados = agenda
      .filter(a => a.data === data)
      .map(a => ({
          inicio: hhmmParaMinutos(a.hora),
          dur: a.duracao
      }));

  horariosBase.forEach(hr => {
    const inicio = hhmmParaMinutos(hr);
    const conflita = ocupados.some(o => intervalosSobrepoem(inicio, servico.duracao, o.inicio, o.dur));

    if(!conflita){
      const op = document.createElement("option");
      op.value = hr;
      op.textContent = hr;
      horaSel.appendChild(op);
    }
  });

  if(horaSel.options.length === 0){
    const op = document.createElement("option");
    op.textContent = "Nenhum hor√°rio dispon√≠vel";
    op.disabled = true;
    op.selected = true;
    horaSel.appendChild(op);
  }
}


// =========================
// AGENDAR
// =========================

function agendar(){
  const nome = document.getElementById("nome")?.value?.trim();
  const data = document.getElementById("data")?.value;
  const hora = document.getElementById("hora")?.value;
  const servicoID = document.getElementById("servico")?.value;

  if(!nome || !data || !hora || !servicoID){
    alert("Preencha todos os campos.");
    return;
  }

  const servico = servicos.find(s => s.id === servicoID);

  let agenda = JSON.parse(localStorage.getItem("agenda")) || [];

  // Verifica√ß√£o final de conflito
  const inicio = hhmmParaMinutos(hora);
  const conflito = agenda
      .filter(a => a.data === data)
      .some(a => intervalosSobrepoem(
          inicio,
          servico.duracao,
          hhmmParaMinutos(a.hora),
          a.duracao
      ));

  if(conflito){
    alert("Esse hor√°rio acabou de ficar indispon√≠vel.");
    atualizarHorarios();
    return;
  }

  // Salvar agenda
  agenda.push({
    nome,
    data,
    hora,
    servico: servico.nome,
    precoTexto: servico.precoTexto,
    duracao: servico.duracao
  });

  localStorage.setItem("agenda", JSON.stringify(agenda));

  mostrarAgenda();
  atualizarHorarios();

  if(adminLogado) mostrarAgendaAdmin();

  // Enviar WhatsApp
  const msg =
`Ol√°! üíÖ
Novo agendamento:

üë§ ${nome}
üíÜ ${servico.nome}
üíµ ${servico.precoTexto}
‚è±Ô∏è 1h
üìÖ ${data}
‚è∞ ${hora}`;

  window.open(`https://wa.me/${telefoneWhatsApp}?text=${encodeURIComponent(msg)}`);

  document.getElementById("nome").value = "";
}


// =========================
// MOSTRAR AGENDA DO CLIENTE
// =========================

function mostrarAgenda(){
  const div = document.getElementById("agenda");
  const nomeBusca = document.getElementById("nome")?.value?.toLowerCase().trim();
  const agenda = JSON.parse(localStorage.getItem("agenda")) || [];

  div.innerHTML = "<h3>Meus Agendamentos</h3>";

  const meus = agenda.filter(a => a.nome.toLowerCase() === nomeBusca);

  if(meus.length === 0){
    div.innerHTML += "<p>Nenhum agendamento encontrado.</p>";
    return;
  }

  meus.forEach((a,i) => {
    div.innerHTML += `
      <div class="item">
        <strong>${a.nome}</strong><br>
        ${a.servico} ‚Äî ${a.precoTexto}<br>
        ${a.data} √†s ${a.hora}<br>
        <button onclick="cancelar(${i})">Cancelar</button>
      </div>`;
  });
}


// =========================
// CANCELAR
// =========================

function cancelar(i){
  let agenda = JSON.parse(localStorage.getItem("agenda")) || [];
  agenda.splice(i,1);
  localStorage.setItem("agenda", JSON.stringify(agenda));
  mostrarAgenda();
  atualizarHorarios();
  if(adminLogado) mostrarAgendaAdmin();
}


// =========================
// ADMIN
// =========================

const ADMIN_USER = "admin";
const ADMIN_PASS = "1234"; // por enquanto simples para evitar erros

function loginAdmin(){
  const u = document.getElementById("adminUser").value;
  const p = document.getElementById("adminPass").value;

  if(u === ADMIN_USER && p === ADMIN_PASS){
    adminLogado = true;
    document.getElementById("adminLogin").style.display = "none";
    document.getElementById("adminArea").style.display = "block";
    mostrarAgendaAdmin();
  } else {
    alert("Usu√°rio ou senha incorretos.");
  }
}

function mostrarAgendaAdmin(){
  const div = document.getElementById("agendaAdmin");
  const agenda = JSON.parse(localStorage.getItem("agenda")) || [];

  div.innerHTML = "<h3>Agenda Completa</h3>";

  agenda.forEach(a => {
    div.innerHTML += `
      <div class="item">
        <strong>${a.nome}</strong><br>
        ${a.servico} ‚Äî ${a.precoTexto}<br>
        ${a.data} √†s ${a.hora}
      </div>`;
  });
}

function logoutAdmin(){
  adminLogado = false;
  document.getElementById("adminArea").style.display = "none";
}


// =========================
// INICIALIZA√á√ÉO
// =========================

window.onload = () => {
  popularServicos();
  mostrarAgenda();
  atualizarHorarios();
};

</script>
