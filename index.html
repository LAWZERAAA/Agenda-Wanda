<script>
/* =========================
   CONFIGURA√á√ÉO
========================= */
const telefoneWhatsApp = "5519992880591";

// Hor√°rios de in√≠cio poss√≠veis (in√≠cio do expediente com passos de 1h)
const horariosBase = ["08:00","09:00","10:00","11:00","13:00","14:00","15:00","16:00","17:00"];

// Tabela de servi√ßos (pre√ßo e dura√ß√£o em minutos)
const servicos = [
  { id: "estetica_pes",     nome: "Est√©tica dos P√©s",         preco: 40,  precoTexto: "R$ 40,00",           duracao: 60 },
  { id: "estetica_maos",    nome: "Est√©tica das M√£os",        preco: 35,  precoTexto: "R$ 35,00",           duracao: 60 },
  { id: "podologia_completa", nome: "Podologia Completa",     preco: 100, precoTexto: "a partir de R$ 100,00", duracao: 60 },
  { id: "plastica_pes",     nome: "Pl√°stica dos P√©s",         preco: 80,  precoTexto: "R$ 80,00",           duracao: 60 },
];

let adminLogado = false;

/* =========================
   UTILIT√ÅRIOS DE DATA/HORA
========================= */
function hhmmParaMinutos(hhmm){
  const [h,m] = hhmm.split(":").map(Number);
  return h*60 + m;
}
function minutosParaHHMM(min){
  const h = Math.floor(min/60).toString().padStart(2,"0");
  const m = (min%60).toString().padStart(2,"0");
  return `${h}:${m}`;
}
// Verifica sobreposi√ß√£o entre [inicio1, fim1) e [inicio2, fim2)
function intervalosSobrepoem(inicio1Min, dur1Min, inicio2Min, dur2Min){
  const fim1 = inicio1Min + dur1Min;
  const fim2 = inicio2Min + dur2Min;
  return (inicio1Min < fim2) && (inicio2Min < fim1);
}
function obterServicoSelecionado(){
  const sel = document.getElementById("servico");
  if(!sel) return null;
  const id = sel.value;
  return servicos.find(s => s.id === id) || null;
}

/* =========================
   UI: SERVI√áOS
========================= */
function popularServicos(){
  const sel = document.getElementById("servico");
  if(!sel) return;

  sel.innerHTML = `<option value="" selected disabled>Selecione um servi√ßo</option>`;
  servicos.forEach(s => {
    const opt = document.createElement("option");
    opt.value = s.id;
    opt.textContent = `${s.nome} ‚Äî ${s.precoTexto} (${(s.duracao/60)}h)`;
    sel.appendChild(opt);
  });

  sel.addEventListener("change", () => {
    mostrarDetalhesServico();
    atualizarHorarios(); // recalcula conforme dura√ß√£o
  });
}
function mostrarDetalhesServico(){
  const box = document.getElementById("detalhesServico");
  if(!box) return;

  const s = obterServicoSelecionado();
  if(!s){
    box.innerHTML = "";
    return;
  }
  box.innerHTML = `
    <div><strong>Servi√ßo:</strong> ${s.nome}</div>
    <div><strong>Valor:</strong> ${s.precoTexto}</div>
    <div><strong>Dura√ß√£o:</strong> ${(s.duracao/60)}h</div>
  `;
}

/* =========================
   HOR√ÅRIOS DISPON√çVEIS
========================= */
function atualizarHorarios(){
  const data = document.getElementById("data")?.value;
  const horaSelect = document.getElementById("hora");
  const s = obterServicoSelecionado();

  if(!horaSelect) return;
  horaSelect.innerHTML = "";

  if(!data || !s){
    const opt = document.createElement("option");
    opt.textContent = !data ? "Selecione uma data primeiro" : "Selecione um servi√ßo";
    opt.disabled = true;
    opt.selected = true;
    horaSelect.appendChild(opt);
    return;
  }

  const agenda = JSON.parse(localStorage.getItem("agenda")) || [];
  const ocupadosDoDia = agenda
    .filter(a => a.data === data)
    .map(a => ({
      inicioMin: hhmmParaMinutos(a.hora),
      durMin: a.duracao || 60 // retrocompat√≠vel
    }));

  const fimExpedienteMin = hhmmParaMinutos(horariosBase[horariosBase.length-1]) + 60; // √∫ltima hora + 1h

  let disponiveis = 0;
  horariosBase.forEach(h => {
    const inicioMin = hhmmParaMinutos(h);
    // respeita o fim do expediente
    if(inicioMin + s.duracao > fimExpedienteMin) return;

    const conflita = ocupadosDoDia.some(ag =>
      intervalosSobrepoem(inicioMin, s.duracao, ag.inicioMin, ag.durMin)
    );
    if(!conflita){
      const opt = document.createElement("option");
      opt.value = h;
      opt.textContent = h;
      horaSelect.appendChild(opt);
      disponiveis++;
    }
  });

  if(disponiveis === 0){
    const opt = document.createElement("option");
    opt.textContent = "Nenhum hor√°rio dispon√≠vel";
    opt.disabled = true;
    opt.selected = true;
    horaSelect.appendChild(opt);
  }
}

/* =========================
   AGENDAR / CANCELAR
========================= */
function agendar(){
  const nome = document.getElementById("nome").value?.trim();
  const data = document.getElementById("data").value;
  const hora = document.getElementById("hora").value;
  const sucesso = document.getElementById("sucesso");
  const selecionado = obterServicoSelecionado();

  if(sucesso) sucesso.style.display = "none";

  if(!nome || !data || !hora || !selecionado){
    alert("Preencha todos os campos corretamente (nome, servi√ßo, data e hor√°rio).");
    return;
  }

  // Valida conflito no momento do agendamento
  const agenda = JSON.parse(localStorage.getItem("agenda")) || [];
  const inicioMin = hhmmParaMinutos(hora);
  const conflita = agenda
    .filter(a => a.data === data)
    .some(a => intervalosSobrepoem(
      inicioMin, selecionado.duracao,
      hhmmParaMinutos(a.hora), a.duracao || 60
    ));

  if(conflita){
    alert("Este hor√°rio acabou de ficar indispon√≠vel. Atualizando op√ß√µes‚Ä¶");
    atualizarHorarios();
    return;
  }

  const registro = {
    nome,
    data,
    hora,
    servicoId: selecionado.id,
    servicoNome: selecionado.nome,
    precoTexto: selecionado.precoTexto,
    duracao: selecionado.duracao
  };

  agenda.push(registro);
  localStorage.setItem("agenda", JSON.stringify(agenda));

  mostrarAgenda();
  atualizarHorarios();
  if(adminLogado) mostrarAgendaAdmin();

  if(sucesso){
    sucesso.style.display = "block";
    setTimeout(() => sucesso.style.display = "none", 4000);
  }

  const msg =
`Ol√°! üíÖ
Novo agendamento:

üë§ ${nome}
üíÜ ${selecionado.nome}
üíµ ${selecionado.precoTexto}
‚è±Ô∏è ${(selecionado.duracao/60)}h
üìÖ ${data}
‚è∞ ${hora}`;

  window.open(`https://wa.me/${telefoneWhatsApp}?text=${encodeURIComponent(msg)}`,"_blank");

  document.getElementById("nome").value = "";
}

function mostrarAgenda(){
  const div = document.getElementById("agenda");
  if(!div) return;

  div.innerHTML = "<h3>Meus Agendamentos</h3>";
  const agenda = JSON.parse(localStorage.getItem("agenda")) || [];
  const nomeCliente = document.getElementById("nome")?.value?.trim()?.toLowerCase() || "";

  // Cliente s√≥ v√™ os seus (n√£o exp√µe os demais)
  agenda.forEach((a, i) => {
    const nomeAg = (a.nome || "").trim().toLowerCase();
    if(nomeCliente && nomeAg === nomeCliente){
      const servicoLabel = a.servicoNome || a.servico || "Servi√ßo";
      const precoLabel = a.precoTexto ? ` ‚Äî ${a.precoTexto}` : "";
      div.innerHTML += `
        <div class="item">
          <strong>${a.nome}</strong><br>
          ${servicoLabel}${precoLabel} (${(a.duracao||60)/60}h)<br>
          ${a.data} √†s ${a.hora}
          <button class="cancelar" onclick="cancelar(${i})">Cancelar</button>
        </div>`;
    }
  });

  if(div.innerHTML.trim() === "<h3>Meus Agendamentos</h3>"){
    div.innerHTML += `<div class="item">Nenhum agendamento encontrado para o nome informado.</div>`;
  }
}

function cancelar(i){
  const agenda = JSON.parse(localStorage.getItem("agenda")) || [];
  if(i >= 0 && i < agenda.length){
    agenda.splice(i,1);
    localStorage.setItem("agenda", JSON.stringify(agenda));
  }
  mostrarAgenda();
  atualizarHorarios();
  if(adminLogado) mostrarAgendaAdmin();
}

/* =========================
   √ÅREA DO ADMIN
   - Senha com hash SHA-256
========================= */
const ADMIN_USER = "admin";
// SHA-256("1234") = 03ac674216f3e15c761ee1a5e255f067953623c8b388b4459e13f978d7c846f4
const ADMIN_PASS_HASH = "03ac674216f3e15c761ee1a5e255f067953623c8b388b4459e13f978d7c846f4";

async function sha256Hex(str){
  const enc = new TextEncoder().encode(str);
  const buf = await crypto.subtle.digest("SHA-256", enc);
  return [...new Uint8Array(buf)].map(b => b.toString(16).padStart(2,"0")).join("");
}

async function loginAdmin(){
  const user = document.getElementById("adminUser").value;
  const pass = document.getElementById("adminPass").value;
  const passHash = await sha256Hex(pass);

  if(user === ADMIN_USER && passHash === ADMIN_PASS_HASH){
    adminLogado = true;
    document.getElementById("adminLogin").style.display = "none";
    document.getElementById("adminArea").style.display = "block";
    mostrarAgendaAdmin();
  } else {
    alert("Usu√°rio ou senha incorretos");
  }
}

function mostrarLogin(){
  const el = document.getElementById("adminLogin");
  if(el) el.style.display = "block";
}

function mostrarAgendaAdmin(){
  const div = document.getElementById("agendaAdmin");
  if(!div) return;

  div.innerHTML = "<h3>Agenda Completa</h3>";
  const agenda = JSON.parse(localStorage.getItem("agenda")) || [];
  agenda
    .sort((a,b) => (a.data + a.hora).localeCompare(b.data + b.hora))
    .forEach(a => {
      const servicoLabel = a.servicoNome || a.servico || "Servi√ßo";
      const precoLabel = a.precoTexto ? ` ‚Äî ${a.precoTexto}` : "";
      div.innerHTML += `
        <div class="item">
          <strong>${a.nome}</strong><br>
          ${servicoLabel}${precoLabel} (${(a.duracao||60)/60}h)<br>
          ${a.data} √†s ${a.hora}
        </div>`;
    });
}

function logoutAdmin(){
  adminLogado = false;
  document.getElementById("adminArea").style.display = "none";
  document.getElementById("adminLogin").style.display = "none";
}

/* =========================
   INICIALIZA√á√ÉO
========================= */
function wireEventos(){
  const dataEl = document.getElementById("data");
  if(dataEl){
    dataEl.addEventListener("change", atualizarHorarios);
  }
}
popularServicos();
mostrarDetalhesServico();
mostrarAgenda();
wireEventos();
atualizarHorarios();
</script>
