<!DOCTYPE html>
<html lang="pt-BR">

<head>
<meta charset="UTF-8" />
<title>Sistema de Agendamentos</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0" />

<style>
  :root{
    --primary:#2563eb;
    --primary-600:#1d4ed8;
    --accent:#10b981;
    --danger:#ef4444;
    --bg:#f6f7fb;
    --text:#111827;
    --muted:#6b7280;
    --card:#ffffff;
    --chip:#eef2ff;
    --chip-text:#1e40af;
    --grid:#e5e7eb;
  }
  *{box-sizing:border-box}
  body{ margin:0; padding:24px; background:var(--bg); font-family: system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif; color:var(--text); }
  .container{ max-width:980px; margin:0 auto; display:grid; gap:24px; grid-template-columns:1fr 1fr; }
  .card{ background:var(--card); border-radius:12px; box-shadow:0 6px 18px rgba(0,0,0,.06); padding:20px; }
  h2,h3{ margin:0 0 12px; }
  label{ display:block; font-weight:600; margin-top:10px; }
  input, select{ width:100%; padding:12px; margin-top:6px; border:1px solid var(--grid); border-radius:8px; background:#fff; }
  button{ appearance:none; border:none; border-radius:10px; padding:12px 14px; cursor:pointer; background:var(--primary); color:#fff; font-weight:600; margin-top:14px; }
  button:hover{ background:var(--primary-600); }
  .btn-outline{ background:#fff; color:var(--primary); border:1px solid var(--primary); }
  .btn-danger{ background:var(--danger); }
  .btn-danger:hover{ background:#dc2626; }
  .success{ display:none; margin-top:10px; padding:10px 12px; border-radius:8px; background:var(--accent); color:#fff; }
  .item{ background:#f9fafb; padding:12px; border-radius:8px; border:1px solid var(--grid); margin-top:10px; }
  .chip{ display:inline-block; padding:3px 8px; border-radius:999px; background:var(--chip); color:var(--chip-text); font-size:12px; margin:3px 6px 0 0; }
  .muted{ color:var(--muted); }
  hr{ border:none; border-top:1px solid var(--grid); margin:16px 0; }
  #adminArea, #adminLogin { display:none; }
  .admin-grid { display:grid; grid-template-columns: 1.1fr .9fr; gap:18px; }
  .calendar-header{ display:flex; align-items:center; justify-content:space-between; margin-bottom:10px; }
  .calendar-header h4{ margin:0; text-transform:capitalize; }
  .calendar-nav button{ margin-left:6px; }
  #calendario table{ width:100%; border-collapse:collapse; }
  #calendario th{ text-align:center; font-weight:700; padding:8px; color:var(--muted); background:#f3f4f6; border:1px solid var(--grid); }
  #calendario td{ vertical-align:top; height:100px; border:1px solid var(--grid); background:#fff; padding:6px; cursor:pointer; position:relative; }
  #calendario td:hover{ background:#f9fafb; }
  .day-number{ font-size:12px; color:var(--muted); }
  .today .day-number{ background:var(--primary); color:#fff; border-radius:999px; padding:2px 6px; }
  .cell-chips{ margin-top:6px; }
  .cell-chips .chip{ font-size:11px; padding:2px 6px; }
  .day-view{ background:#fff; border:1px solid var(--grid); border-radius:10px; overflow:hidden; }
  .day-toolbar{ display:flex; align-items:center; justify-content:space-between; padding:10px 12px; background:#f8fafc; border-bottom:1px solid var(--grid); }
  .timeline{ display:grid; grid-template-columns: 70px 1fr; position:relative; height: 640px; }
  .hours{ border-right:1px solid var(--grid); background:#fbfbfb; }
  .hour{ height:64px; border-bottom:1px dashed #e5e7eb; font-size:12px; color:var(--muted); display:flex; align-items:flex-start; justify-content:center; padding-top:2px; }
  .slots{ position:relative; background:#fff; }
  .event{ position:absolute; left:6px; right:6px; border-left:4px solid var(--primary); background:#eef2ff; color:#1e293b; border-radius:8px; padding:8px 10px; box-shadow: 0 4px 10px rgba(0,0,0,.06); display:flex; flex-direction:column; gap:4px; }
  .event .title{ font-weight:700; }
  .event .meta{ font-size:12px; color:#334155; }
  .event .actions{ display:flex; gap:8px; margin-top:4px; }
  .no-events{ padding:12px; color:var(--muted); }
  @media (max-width: 980px){
    .container{ grid-template-columns:1fr; }
    .admin-grid{ grid-template-columns:1fr; }
  }
</style>
</head>

<body>

<div class="container">
  <!-- Cliente -->
  <div class="card">
    <h2>Agendamentos</h2>

    <label>Nome</label>
    <input id="nome" type="text" placeholder="Seu nome" oninput="mostrarAgenda()" />

    <label>WhatsApp para Contato</label>
    <input id="contato" type="text" placeholder="(DDD) 99999-9999" />

    <label>Servi√ßo</label>
    <select id="servico"></select>

    <label>Data</label>
    <input id="data" type="date" onchange="atualizarHorarios()" />

    <label>Hor√°rio</label>
    <select id="hora"></select>
    <div id="msgHorarios" class="muted" style="margin-top:6px;"></div>

    <button onclick="agendar()">Agendar</button>

    <div id="sucesso" class="success">Agendado com sucesso!</div>

    <h3 style="margin-top:18px;">Meus Agendamentos</h3>
    <div id="agenda"></div>
  </div>

  <!-- Admin -->
  <div class="card">
    <h2>Painel do Administrador</h2>
    <button class="btn-outline" onclick="mostrarLogin()">Entrar / Trocar Usu√°rio</button>

    <div id="adminLogin" style="margin-top:10px;">
      <h3>Login</h3>
      <input id="adminUser" placeholder="Usu√°rio" />
      <input id="adminPass" type="password" placeholder="Senha" />
      <button onclick="loginAdmin()">Entrar</button>
    </div>

    <div id="adminArea">
      <div class="admin-grid">
        <div class="card" style="padding:12px;">
          <div class="calendar-header">
            <h3>Calend√°rio (Mensal)</h3>
            <div class="calendar-nav">
              <button class="btn-outline" onclick="mesAnterior()">‚óÄ M√™s Anterior</button>
              <button class="btn-outline" onclick="mesSeguinte()">Pr√≥ximo M√™s ‚ñ∂</button>
            </div>
          </div>
          <div id="calendario"></div>
        </div>

        <div class="card" style="padding:12px;">
          <div class="day-view">
            <div class="day-toolbar">
              <strong id="diaTitulo">Dia</strong>
              <div>
                <button class="btn-outline" onclick="diaAnterior()">‚óÄ Dia</button>
                <button class="btn-outline" onclick="diaSeguinte()">Dia ‚ñ∂</button>
              </div>
            </div>
            <div class="timeline">
              <div class="hours" id="hoursCol"></div>
              <div class="slots" id="daySlots"></div>
            </div>
            <div id="listaDiaVazia" class="no-events" style="display:none;">Sem agendamentos neste dia.</div>
          </div>
        </div>
      </div>

      <button class="btn-danger" onclick="logoutAdmin()">Sair</button>
    </div>
  </div>
</div>

<script>
/* =========================
   CONFIG
========================= */
// Telefone do ADMIN (WhatsApp) ‚Äî **SOMENTE D√çGITOS** com DDI (ex.: 55+DDD+N√öMERO)
const telefoneWhatsApp = "5519992880591";

// Funcionamento: Seg (1) a S√°b (6), 08:00‚Äì17:00. Dura√ß√£o: 1h => slots 08:00..16:00
const START_DAY_MIN = 8 * 60;
const END_DAY_MIN   = 17 * 60;
const SLOT_MIN      = 60;

// Gera hor√°rios base automaticamente conforme funcionamento
function gerarHorariosBase(){
  const arr = [];
  for(let m=START_DAY_MIN; m + SLOT_MIN <= END_DAY_MIN; m += SLOT_MIN){
    arr.push(minutosParaHHMM(m));
  }
  return arr;
}
const horariosBase = gerarHorariosBase();

const servicos = [
  { id: "estetica_pes",       nome: "Est√©tica dos P√©s",         precoTexto: "R$ 40,00",              duracao: 60 },
  { id: "estetica_maos",      nome: "Est√©tica das M√£os",        precoTexto: "R$ 35,00",              duracao: 60 },
  { id: "podologia_completa", nome: "Podologia Completa",       precoTexto: "a partir de R$ 100,00", duracao: 60 },
  { id: "plastica_pes",       nome: "Pl√°stica dos P√©s",         precoTexto: "R$ 80,00",              duracao: 60 }
];

let adminLogado = false;
let currentYear  = new Date().getFullYear();
let currentMonth = new Date().getMonth();
let selectedDate = toDateInputValue(new Date());

/* =========================
   Utils
========================= */
function hhmmParaMinutos(hhmm){ const [h,m] = hhmm.split(":").map(Number); return h*60+m; }
function minutosParaHHMM(min){ const h = String(Math.floor(min/60)).padStart(2,"0"); const m = String(min%60).padStart(2,"0"); return `${h}:${m}`; }
function intervalosSobrepoem(aInicio, aDur, bInicio, bDur){ return (aInicio < bInicio+bDur) && (bInicio < aInicio+aDur); }
function toDateInputValue(d){
  const y = d.getFullYear(); const m = String(d.getMonth()+1).padStart(2,"0"); const day = String(d.getDate()).padStart(2,"0");
  return `${y}-${m}-${day}`;
}
function gerarId(){ return Date.now().toString(36) + Math.random().toString(36).slice(2,8); }
function soDigitos(s){ return (s||"").replace(/\D/g,""); }
function isSunday(dateStr){
  const [y,m,d] = dateStr.split("-").map(Number);
  const wd = new Date(y, m-1, d).getDay(); // 0=Dom
  return wd === 0;
}
function isPastDate(dateStr){
  const hoje = new Date(); hoje.setHours(0,0,0,0);
  const d = new Date(dateStr+"T00:00:00");
  return d < hoje;
}
function isPastTimeOnDate(dateStr, hhmm){
  const now = new Date();
  const [h,m] = hhmm.split(":").map(Number);
  const target = new Date(dateStr+"T00:00:00");
  target.setHours(h, m, 0, 0);
  return target <= now;
}

/* =========================
   Storage (migra√ß√£o)
========================= */
function getAgenda(){
  let agenda = JSON.parse(localStorage.getItem("agenda")) || [];
  let changed = false;
  agenda = agenda.map(a=>{
    if(!a.id){ a.id = gerarId(); changed = true; }
    if(!a.duracao){ a.duracao = 60; changed = true; }
    return a;
  });
  if(changed) localStorage.setItem("agenda", JSON.stringify(agenda));
  return agenda;
}
function setAgenda(agenda){ localStorage.setItem("agenda", JSON.stringify(agenda)); }

/* =========================
   Servi√ßos e hor√°rios
========================= */
function popularServicos(){
  const sel = document.getElementById("servico");
  sel.innerHTML = `<option value="" disabled selected>Selecione o servi√ßo</option>`;
  servicos.forEach(s=>{
    const op = document.createElement("option");
    op.value = s.id;
    op.textContent = `${s.nome} ‚Äî ${s.precoTexto} (${s.duracao/60}h)`;
    sel.appendChild(op);
  });
  sel.onchange = atualizarHorarios;
}

function atualizarHorarios(){
  const data = document.getElementById("data").value;
  const selServico = document.getElementById("servico").value;
  const horaSel = document.getElementById("hora");
  const msg = document.getElementById("msgHorarios");

  horaSel.innerHTML = "";

  // Regras: sem data/servi√ßo ‚Üí sem hor√°rios
  if(!data || !selServico){
    msg.textContent = "Selecione data e servi√ßo.";
    return;
  }

  // Bloquear domingo e datas passadas
  if(isSunday(data)){
    msg.textContent = "Domingo indispon√≠vel. Escolha outro dia."; return;
  }
  if(isPastDate(data)){
    msg.textContent = "Data j√° passou. Escolha outra."; return;
  }

  msg.textContent = "Carregando hor√°rios‚Ä¶";

  const servico = servicos.find(s=>s.id===selServico);
  const agenda = getAgenda();
  const ocupados = agenda
    .filter(a => a.data === data)
    .map(a => ({inicio: hhmmParaMinutos(a.hora), dur: a.duracao}));

  // Gerar hor√°rios dispon√≠veis com regras do dia atual
  let disponiveis = 0;
  for(const hr of horariosBase){
    const inicio = hhmmParaMinutos(hr);

    // N√£o permitir hora passada no pr√≥prio dia
    if(!isPastDate(data) && isPastTimeOnDate(data, hr)) continue;

    const conflita = ocupados.some(o=>intervalosSobrepoem(inicio, servico.duracao, o.inicio, o.dur));
    if(!conflita){
      const op = document.createElement("option");
      op.value = hr; op.textContent = hr;
      horaSel.appendChild(op);
      disponiveis++;
    }
  }

  msg.textContent = (disponiveis>0) ? "Hor√°rios dispon√≠veis:" : "Nenhum hor√°rio dispon√≠vel nesta data.";
}

/* =========================
   Agendar / Cancelar (Cliente)
========================= */
function agendar(){
  const nome = document.getElementById("nome").value.trim();
  const contatoRaw = document.getElementById("contato").value.trim();
  const data = document.getElementById("data").value;
  const hora = document.getElementById("hora").value;
  const servicoID = document.getElementById("servico").value;

  if(!nome || !contatoRaw || !data || !hora || !servicoID){
    alert("Preencha todos os campos."); return;
  }

  // Regras de data/hora
  if(isSunday(data)){ alert("Domingo indispon√≠vel."); return; }
  if(isPastDate(data)){ alert("Data j√° passou."); return; }
  if(isPastTimeOnDate(data, hora)){ alert("Hor√°rio j√° passou."); return; }

  const servico = servicos.find(s=>s.id===servicoID);
  const agenda = getAgenda();

  // Impedir hor√°rios repetidos (mesma data/hora) e conflitos por dura√ß√£o
  const inicio = hhmmParaMinutos(hora);
  const mesmoSlot = agenda.some(a => a.data===data && a.hora===hora);
  if(mesmoSlot){
    alert("Este hor√°rio j√° est√° ocupado."); atualizarHorarios(); return;
  }
  const conflita = agenda
    .filter(a=>a.data===data)
    .some(a=>intervalosSobrepoem(inicio, servico.duracao, hhmmParaMinutos(a.hora), a.duracao));
  if(conflita){
    alert("Conflito de hor√°rio. Escolha outro hor√°rio."); atualizarHorarios(); return;
  }

  const contato = soDigitos(contatoRaw);
  const registro = {
    id: gerarId(),
    nome,
    contato, // salvo s√≥ d√≠gitos
    data,
    hora,
    servico: servico.nome,
    precoTexto: servico.precoTexto,
    duracao: servico.duracao
  };

  agenda.push(registro);
  setAgenda(agenda);

  document.getElementById("sucesso").style.display = "block";
  setTimeout(()=>document.getElementById("sucesso").style.display="none", 3000);

  mostrarAgenda(); atualizarHorarios();
  if(adminLogado){ renderCalendario(); renderDia(selectedDate); }

  // Enviar WhatsApp ao ADMIN com texto realmente preenchido
  const msg =
`Ol√°! üíÖ
Novo agendamento:

üë§ ${nome}
üí¨ Contato: +55 ${contato}
üíÜ ${servico.nome}
üíµ ${servico.precoTexto}
‚è±Ô∏è ${servico.duracao/60}h
üìÖ ${data}
‚è∞ ${hora}`;

  abrirWhatsApp(`https://wa.me/${telefoneWhatsApp}?text=${encodeURIComponent(msg)}`);
}

function abrirWhatsApp(url){
  // Tenta navegar na mesma aba (melhor para preencher o texto)
  try{
    window.location.href = url;
  }catch(e){
    // Fallback em nova aba se bloqueado
    window.open(url, "_blank");
  }
}

function mostrarAgenda(){
  const wrap = document.getElementById("agenda");
  const nomeBusca = (document.getElementById("nome").value || "").toLowerCase().trim();
  const agenda = getAgenda().filter(a => a.nome.toLowerCase() === nomeBusca)
                             .sort((a,b)=>(a.data+a.hora).localeCompare(b.data+b.hora));

  wrap.innerHTML = "";
  if(agenda.length===0){ wrap.innerHTML = `<div class="muted">Nenhum agendamento encontrado.</div>`; return; }

  agenda.forEach(a=>{
    wrap.innerHTML += `
      <div class="item">
        <strong>${a.nome}</strong><br/>
        ${a.servico} ‚Äî ${a.precoTexto}<br/>
        WhatsApp: +55 ${a.contato}<br/>
        ${a.data} √†s ${a.hora}<br/>
        <button class="btn-danger" onclick="cancelarCliente('${a.id}')">Cancelar</button>
      </div>`;
  });
}

function cancelarCliente(id){
  if(!confirm("Deseja cancelar este agendamento?")) return;

  const agenda = getAgenda();
  const idx = agenda.findIndex(a=>a.id===id);
  if(idx===-1) return;
  const item = agenda[idx];

  agenda.splice(idx,1);
  setAgenda(agenda);

  mostrarAgenda(); atualizarHorarios();
  if(adminLogado){ renderCalendario(); renderDia(selectedDate); }

  // Notificar ADMIN do cancelamento realizado pelo cliente
  const msg =
`‚ö†Ô∏è Cancelamento pelo cliente

üë§ ${item.nome}
üí¨ Contato: +55 ${item.contato}
üíÜ ${item.servico}
üìÖ ${item.data}
‚è∞ ${item.hora}`;
  abrirWhatsApp(`https://wa.me/${telefoneWhatsApp}?text=${encodeURIComponent(msg)}`);
}

/* =========================
   Admin Login
========================= */
const ADMIN_USER = "admin";
const ADMIN_PASS = "1234";

function mostrarLogin(){ document.getElementById("adminLogin").style.display = "block"; }
function loginAdmin(){
  const u = document.getElementById("adminUser").value;
  const p = document.getElementById("adminPass").value;
  if(u===ADMIN_USER && p===ADMIN_PASS){
    adminLogado = true;
    document.getElementById("adminLogin").style.display = "none";
    document.getElementById("adminArea").style.display = "block";
    buildHoursColumn();
    renderCalendario();
    renderDia(selectedDate);
  }else{
    alert("Credenciais incorretas.");
  }
}
function logoutAdmin(){
  adminLogado = false;
  document.getElementById("adminArea").style.display = "none";
}

/* =========================
   Calend√°rio Mensal
========================= */
function renderCalendario(){
  const cal = document.getElementById("calendario");
  const primeiro = new Date(currentYear, currentMonth, 1);
  const ultimo = new Date(currentYear, currentMonth+1, 0);
  const todayStr = toDateInputValue(new Date());
  const mesNome = primeiro.toLocaleDateString('pt-BR',{month:'long',year:'numeric'});

  let html = `<h4 style="text-transform:capitalize; margin:6px 0 8px;">${mesNome}</h4>`;
  html += `<table><thead><tr>`;
  const dias = ["Dom","Seg","Ter","Qua","Qui","Sex","S√°b"];
  dias.forEach(d=> html += `<th>${d}</th>`);
  html += `</tr></thead><tbody><tr>`;

  let diaSemana = primeiro.getDay(); // 0..6
  for(let i=0;i<diaSemana;i++){ html += `<td></td>`; }

  const agenda = getAgenda();

  for(let dia=1; dia<=ultimo.getDate(); dia++){
    const dataStr = `${currentYear}-${String(currentMonth+1).padStart(2,'0')}-${String(dia).padStart(2,'0')}`;
    const items = agenda.filter(a=>a.data===dataStr).sort((a,b)=>a.hora.localeCompare(b.hora));
    const isToday = (dataStr===todayStr);
    const domingo = isSunday(dataStr);

    html += `<td class="${isToday?'today':''}" onclick="selecionarDia('${dataStr}')"
              style="${domingo?'background:#fff5f5;':''}">`;
    html += `<div class="day-number">${dia}</div>`;
    if(items.length>0){
      html += `<div class="cell-chips">`;
      items.slice(0,4).forEach(it=>{ html += `<span class="chip">${it.hora}</span>`; });
      if(items.length>4){ html += `<span class="chip">+${items.length-4}</span>`; }
      html += `</div>`;
    }
    html += `</td>`;

    if((dia + diaSemana) % 7 === 0) html += `</tr><tr>`;
  }

  html += `</tr></tbody></table>`;
  cal.innerHTML = html;
}
function selecionarDia(dateStr){ selectedDate = dateStr; renderDia(selectedDate); }
function mesAnterior(){ currentMonth--; if(currentMonth<0){ currentMonth=11; currentYear--; } renderCalendario(); }
function mesSeguinte(){ currentMonth++; if(currentMonth>11){ currentMonth=0; currentYear++; } renderCalendario(); }

/* =========================
   Vis√£o do Dia (Teams-like)
========================= */
function buildHoursColumn(){
  const hoursCol = document.getElementById("hoursCol");
  hoursCol.innerHTML = "";
  for(let m=START_DAY_MIN; m<=END_DAY_MIN; m+=60){
    const label = minutosParaHHMM(m);
    hoursCol.innerHTML += `<div class="hour">${label}</div>`;
  }
}
function renderDia(dateStr){
  const titulo = document.getElementById("diaTitulo");
  const slots = document.getElementById("daySlots");
  const empty = document.getElementById("listaDiaVazia");

  const d = new Date(dateStr);
  titulo.textContent = d.toLocaleDateString('pt-BR', { weekday:'long', day:'2-digit', month:'long', year:'numeric' });

  slots.innerHTML = "";
  const agenda = getAgenda()
    .filter(a=>a.data===dateStr)
    .sort((a,b)=>a.hora.localeCompare(b.hora));

  if(agenda.length===0){ empty.style.display = "block"; return; } else { empty.style.display = "none"; }

  const pxPerMin = 64/60;
  agenda.forEach(a=>{
    const startMin = hhmmParaMinutos(a.hora);
    const top = (startMin - START_DAY_MIN) * pxPerMin;
    const height = (a.duracao || 60) * pxPerMin;
    const el = document.createElement("div");
    el.className = "event";
    el.style.top = `${top}px`;
    el.style.height = `${height}px`;
    el.innerHTML = `
      <div class="title">${a.hora} ¬∑ ${a.servico}</div>
      <div class="meta">Cliente: <strong>${a.nome}</strong> ‚Äî <span class="muted">${a.precoTexto}</span></div>
      <div class="meta">WhatsApp: +55 ${a.contato || '-'}</div>
      <div class="actions">
        <button class="btn-danger" onclick="cancelarAdminById('${a.id}')">Cancelar</button>
      </div>
    `;
    slots.appendChild(el);
  });
}
function diaAnterior(){ const d = new Date(selectedDate); d.setDate(d.getDate()-1); selectedDate = toDateInputValue(d); renderDia(selectedDate); }
function diaSeguinte(){ const d = new Date(selectedDate); d.setDate(d.getDate()+1); selectedDate = toDateInputValue(d); renderDia(selectedDate); }

/* =========================
   Admin: cancelar agenda (avisa cliente)
========================= */
function cancelarAdminById(id){
  if(!confirm("Deseja cancelar este hor√°rio?")) return;

  const agenda = getAgenda();
  const idx = agenda.findIndex(a=>a.id===id);
  if(idx===-1) return;
  const item = agenda[idx];

  agenda.splice(idx,1);
  setAgenda(agenda);

  // Mensagem ao cliente
  const msgCliente =
`Ol√° ${item.nome}! ‚ùå
Seu agendamento foi cancelado pelo administrador.
${item.servico}
üìÖ ${item.data} ‚è∞ ${item.hora}

Se quiser remarcar, √© s√≥ responder esta mensagem.`;
  const foneCliente = `55${soDigitos(item.contato)}`;
  if(foneCliente.length >= 12){
    abrirWhatsApp(`https://wa.me/${foneCliente}?text=${encodeURIComponent(msgCliente)}`);
  }else{
    alert("N√£o foi poss√≠vel enviar ao cliente (WhatsApp inv√°lido).");
  }

  renderCalendario();
  renderDia(selectedDate);
}

/* =========================
   Inicializa√ß√£o
========================= */
window.onload = ()=>{
  popularServicos();
  document.getElementById("msgHorarios").textContent = "Selecione data e servi√ßo.";
  getAgenda(); // migra√ß√£o e cache
  mostrarAgenda();
};
</script>

</body>
</html>
